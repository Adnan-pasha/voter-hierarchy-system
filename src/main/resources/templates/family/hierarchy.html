<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hierarchy - Civic Nest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #2c3e50 !important;
        }

        .navbar-brand {
            font-weight: bold;
            color: #fff !important;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }

        .hierarchy-tree {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }

        .hierarchy-node {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.25rem;
        }

        .hierarchy-head {
            background-color: #0d6efd;
            color: white;
        }

        .hierarchy-member {
            background-color: #e9ecef;
            border-left: 3px solid #6c757d;
            margin-left: 2rem;
        }

        .validation-error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/families/dashboard">
                <i class="bi bi-people-fill"></i> Civic Nest
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/families/dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/families">
                            <i class="bi bi-list"></i> Families
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/families/search">
                            <i class="bi bi-search"></i> Search
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                        <a class="nav-link" href="/families/new">
                            <i class="bi bi-plus-circle"></i> New Family
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" href="/users">
                            <i class="bi bi-person-gear"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link text-white-50">
                            <i class="bi bi-person-circle"></i>
                            <span sec:authentication="name">User</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" class="d-inline">
                            <button type="submit" class="nav-link btn btn-link text-white">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-diagram-3"></i> Family Hierarchy</h2>
            <div>
                <a th:href="@{/families/{id}/blo-sheet(id=${family.id})}" class="btn btn-info" target="_blank">
                    <i class="bi bi-printer"></i> BLO Verification Sheet
                </a>
                <a th:href="@{/families/{id}/edit(id=${family.id})}" class="btn btn-warning" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                    <i class="bi bi-pencil"></i> Edit Family
                </a>
                <a th:href="@{/families/{id}/members/new(id=${family.id})}" class="btn btn-primary" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                    <i class="bi bi-person-plus"></i> Add More Members
                </a>
                <a th:href="@{/families/{id}/finish(id=${family.id})}" class="btn btn-success" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                    <i class="bi bi-check-circle"></i> Finish Collection
                </a>
            </div>
        </div>

        <!-- Family Info Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-house-door"></i> Family Code:
                    <span th:text="${family.familyCode}">FAM-XXX</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Total Members:</strong>
                        <span class="badge bg-info"
                            th:text="${family.members != null ? (family.members.size()) : 1}">1</span>
                        (including head)
                    </div>
                    <div class="col-md-4">
                        <strong>Created:</strong>
                        <span th:if="${family.createdAt != null}"
                            th:text="${#temporals.format(family.createdAt, 'dd-MM-yyyy HH:mm')}"></span>
                    </div>
                    <div class="col-md-4">
                        <strong>Last Updated:</strong>
                        <span th:if="${family.updatedAt != null}"
                            th:text="${#temporals.format(family.updatedAt, 'dd-MM-yyyy HH:mm')}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Errors -->
        <div th:if="${hasErrors != null && hasErrors}" class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Hierarchy Validation Errors
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <strong>The following validation errors were found based on CURRENT voter ID data:</strong>
                </p>

                <div th:each="error : ${validationErrors}" class="validation-error">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-x-circle text-danger me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong th:text="${error.relationType}">RELATION</strong> -
                            <span th:text="${error.memberName}">Member Name</span>
                            <br>
                            <span th:text="${error.errorMessage}">Error message</span>
                            <br>
                            <small>
                                <strong>Expected:</strong> <span th:text="${error.expectedValue}"></span>
                                <br>
                                <strong>Found:</strong> <span th:text="${error.foundValue}"></span>
                            </small>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0">
                    <i class="bi bi-info-circle"></i>
                    <strong>Note:</strong> These errors are based on validation using CURRENT voter ID data only.
                    2002 voter list data, age, and status are not considered in validation.
                    Please correct the member details or family head name to resolve these mismatches.
                </div>
            </div>
        </div>

        <div th:if="${hasErrors == null || !hasErrors}" class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Success!</strong> Family hierarchy is valid. All relationships are correctly matched.
        </div>

        <!-- Hierarchy Tree -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-tree"></i> Family Tree Structure
                </h5>
            </div>
            <div class="card-body">
                <div class="hierarchy-tree">
                    <!-- Family Head -->
                    <div th:if="${hierarchy != null && hierarchy.isFamilyHead}" class="hierarchy-node hierarchy-head">
                        <strong><i class="bi bi-person-badge"></i> FAMILY HEAD</strong>
                        <br>
                        <strong>Name (2002):</strong> <span th:text="${hierarchy.name2002}"></span>
                        <br>
                        <strong>Parent/Spouse (2002):</strong> <span th:text="${hierarchy.parentSpouseName2002}"></span>
                        <br>
                        <span class="badge"
                            th:classappend="${hierarchy.status != null && hierarchy.status.name() == 'ACTIVE' ? 'bg-success' : 'bg-secondary'}"
                            th:text="${hierarchy.status != null ? hierarchy.status.displayName : 'Unknown'}">
                        </span>
                    </div>

                    <!-- Family Members -->
                    <div th:if="${hierarchy != null && hierarchy.children != null}"
                        th:each="child : ${hierarchy.children}">
                        <div class="hierarchy-node hierarchy-member">
                            <strong
                                th:text="${child.relationType != null ? child.relationType.displayName : 'UNKNOWN'}">RELATION</strong>
                            <span class="badge ms-2"
                                th:classappend="${child.status != null && child.status.name() == 'ACTIVE' ? 'bg-success' : 'bg-secondary'}"
                                th:text="${child.status != null ? child.status.displayName : 'Unknown'}">
                            </span>

                            <div th:if="${child.nameCurrent != null}">
                                <br>
                                <strong>Name (Current):</strong> <span th:text="${child.nameCurrent}"></span>
                                <br>
                                <strong>Parent/Spouse (Current):</strong> <span
                                    th:text="${child.parentSpouseNameCurrent}"></span>
                            </div>

                            <div th:if="${child.nameCurrent == null}" class="text-muted">
                                <br>
                                <em>(No current voter details)</em>
                            </div>
                        </div>
                        <!-- Edit and Delete Buttons for Members -->
                        <div class="ms-3" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                            <div class="btn-group-vertical btn-group-sm" role="group">
                                <a th:href="@{/families/{familyId}/members/{memberId}/edit(familyId=${family.id},memberId=${child.personId})}"
                                    class="btn btn-warning" title="Edit Member">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <button type="button" class="btn btn-danger" title="Delete Member"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target='#deleteMemberModal' + ${child.personId}">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <!-- Delete Member Modal -->
                        <div class="modal fade" th:id="'deleteMemberModal' + ${child.personId}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title">
                                            <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white"
                                            data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Are you sure you want to delete this member?</p>
                                        <div th:if="${child.nameCurrent != null}" class="alert alert-info">
                                            <strong>Name:</strong> <span th:text="${child.nameCurrent}"></span><br>
                                            <strong>Relation:</strong> <span
                                                th:text="${child.relationType.displayName}"></span>
                                        </div>
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <strong>Warning:</strong> This action cannot be undone!
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                        <form
                                            th:action="@{/families/{familyId}/members/{memberId}/delete(familyId=${family.id},memberId=${child.personId})}"
                                            method="post" class="d-inline">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="bi bi-trash"></i> Delete Member
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div th:if="${hierarchy == null || hierarchy.children == null || hierarchy.children.isEmpty()}"
                        class="text-muted mt-3">
                        <em>No family members added yet.</em>
                    </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i>
                    <strong>Hierarchy Display Rules:</strong>
                    <ul class="mb-0">
                        <li>Family Head shows 2002 voter details</li>
                        <li>Family Members show CURRENT voter details (if available)</li>
                        <li>2002 details for members are NOT shown in preview</li>
                        <li>Validation is performed using CURRENT voter ID data only</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
        <div class="container">
            <p class="text-muted mb-0">
                <small>Family-wise Voter Hierarchy Collection System | SIR Data Collection</small>
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Print functionality
        function printHierarchy() {
            window.print();
        }
    </script>
</body>

</html>